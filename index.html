<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>NOTE2U - Valentine Card Creator</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&family=Quicksand:wght@400;500;600;700&family=Pacifico&family=Lobster&family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { min-height: 100%; font-family: 'Quicksand', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #fff; overflow-x: hidden; }

        /* Ambient Background with Floating Hearts */
        .ambient-bg { position: fixed; inset: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%); background-size: 400% 400%; animation: ambientFlow 20s ease infinite; z-index: -1; overflow: hidden; }
        @keyframes ambientFlow { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }

        /* Floating Hearts */
        .floating-hearts { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
        .heart { position: absolute; font-size: 1.5rem; opacity: 0.15; animation: floatUp 15s linear infinite; }
        .heart:nth-child(1) { left: 5%; animation-delay: 0s; animation-duration: 12s; }
        .heart:nth-child(2) { left: 15%; animation-delay: 2s; animation-duration: 14s; font-size: 1rem; }
        .heart:nth-child(3) { left: 25%; animation-delay: 4s; animation-duration: 16s; }
        .heart:nth-child(4) { left: 35%; animation-delay: 1s; animation-duration: 13s; font-size: 2rem; }
        .heart:nth-child(5) { left: 45%; animation-delay: 3s; animation-duration: 15s; }
        .heart:nth-child(6) { left: 55%; animation-delay: 5s; animation-duration: 11s; font-size: 1.2rem; }
        .heart:nth-child(7) { left: 65%; animation-delay: 2.5s; animation-duration: 14s; }
        .heart:nth-child(8) { left: 75%; animation-delay: 0.5s; animation-duration: 17s; font-size: 1.8rem; }
        .heart:nth-child(9) { left: 85%; animation-delay: 3.5s; animation-duration: 12s; }
        .heart:nth-child(10) { left: 95%; animation-delay: 1.5s; animation-duration: 16s; font-size: 1.3rem; }
        @keyframes floatUp {
            0% { transform: translateY(100vh) rotate(0deg) scale(1); opacity: 0; }
            10% { opacity: 0.15; }
            90% { opacity: 0.15; }
            100% { transform: translateY(-100vh) rotate(360deg) scale(0.5); opacity: 0; }
        }

        /* Sparkle effect */
        .sparkles { position: fixed; inset: 0; pointer-events: none; z-index: 1; }
        .sparkle { position: absolute; width: 4px; height: 4px; background: #fff; border-radius: 50%; animation: sparkle 3s ease-in-out infinite; }
        .sparkle:nth-child(1) { left: 10%; top: 20%; animation-delay: 0s; }
        .sparkle:nth-child(2) { left: 20%; top: 60%; animation-delay: 0.5s; }
        .sparkle:nth-child(3) { left: 30%; top: 40%; animation-delay: 1s; }
        .sparkle:nth-child(4) { left: 50%; top: 80%; animation-delay: 1.5s; }
        .sparkle:nth-child(5) { left: 70%; top: 30%; animation-delay: 2s; }
        .sparkle:nth-child(6) { left: 80%; top: 70%; animation-delay: 2.5s; }
        .sparkle:nth-child(7) { left: 90%; top: 50%; animation-delay: 0.3s; }
        .sparkle:nth-child(8) { left: 40%; top: 15%; animation-delay: 1.2s; }
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 0.8; transform: scale(1); }
        }

        .app { max-width: 500px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
        .app.view-mode { padding-bottom: 20px; }

        /* Header */
        .header { text-align: center; margin-bottom: 20px; opacity: 0; animation: fadeSlideDown 0.8s ease 0.2s forwards; }
        .header h1 { font-family: 'Dancing Script', cursive; font-size: 2.8rem; background: linear-gradient(135deg, #ff6b9d, #ff1744, #ffb6c1, #ff6b9d); background-size: 300% 300%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: shimmer 3s ease infinite; filter: drop-shadow(0 0 15px rgba(255,107,157,0.4)); }
        @keyframes shimmer { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        .header p { font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 5px; }

        @keyframes fadeSlideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes softPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        @keyframes gentleGlow { 0%, 100% { box-shadow: 0 0 20px rgba(255,107,157,0.2); } 50% { box-shadow: 0 0 30px rgba(255,107,157,0.4); } }

        /* Envelope & Card Container */
        .card-area { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; opacity: 0; animation: fadeSlideUp 0.8s ease 0.4s forwards; }

        /* Envelope */
        .envelope { width: 260px; height: 170px; position: relative; cursor: pointer; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); animation: softPulse 3s ease infinite; }
        .envelope:hover { transform: scale(1.03); }
        .envelope:active { transform: scale(0.98); }
        .envelope.hidden { display: none; }

        .envelope-back { position: absolute; width: 100%; height: 100%; background: linear-gradient(180deg, #e74c3c, #c0392b); border-radius: 0 0 14px 14px; box-shadow: 0 15px 40px rgba(0,0,0,0.4); }
        .envelope-front { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(180deg, #ff6b6b, #ee5a5a); border-radius: 0 0 14px 14px; display: flex; align-items: center; justify-content: center; z-index: 2; }
        .envelope-front p { font-family: 'Dancing Script', cursive; font-size: 1.3rem; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        .envelope-flap { position: absolute; top: 0; left: 0; width: 100%; height: 50%; background: linear-gradient(135deg, #ff6b6b, #e74c3c); clip-path: polygon(0 0, 50% 100%, 100% 0); z-index: 3; transform-origin: top center; transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .envelope.opening .envelope-flap { transform: rotateX(180deg); }

        .seal { position: absolute; top: 25%; left: 50%; transform: translateX(-50%); font-size: 2.2rem; z-index: 4; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4)); transition: opacity 0.4s, transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .envelope.opening .seal { opacity: 0; transform: translateX(-50%) scale(0) rotate(180deg); }

        .tap-hint { margin-top: 15px; font-size: 0.85rem; color: rgba(255,255,255,0.5); animation: pulse 2s ease infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

        /* Card */
        .card-wrapper { display: none; text-align: center; }
        .card-wrapper.visible { display: block; animation: cardReveal 1s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes cardReveal {
            0% { opacity: 0; transform: translateY(-50px) scale(0.8) rotateX(20deg); }
            100% { opacity: 1; transform: translateY(0) scale(1) rotateX(0); }
        }

        .card { width: 260px; height: 360px; perspective: 1200px; cursor: pointer; margin: 0 auto; }
        .card-inner { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .card.flipped .card-inner { transform: rotateY(180deg); }

        .card-face { position: absolute; top: 0; left: 0; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; border-radius: 18px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

        .card-front { background: linear-gradient(135deg, var(--card-color1, #ff1744), var(--card-color2, #d50000)); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; position: relative; }
        .card-front::before { content: ''; position: absolute; inset: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 12px; animation: borderGlow 3s ease infinite; }
        @keyframes borderGlow { 0%, 100% { border-color: rgba(255,255,255,0.3); } 50% { border-color: rgba(255,255,255,0.5); } }

        .card-emoji { font-size: 3.8rem; margin-bottom: 15px; animation: floatEmoji 3s ease infinite; }
        @keyframes floatEmoji { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .card-title { font-size: 1.5rem; color: #fff; text-align: center; text-shadow: 0 2px 10px rgba(0,0,0,0.4); line-height: 1.3; }

        .card-back { background: linear-gradient(180deg, #fff5f5, #ffe4e9); transform: rotateY(180deg); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; text-align: center; }
        .card-to { font-size: 0.9rem; color: #c41e3a; margin-bottom: 8px; }
        .card-to span { font-size: 1.3rem; }
        .card-msg { font-size: 0.95rem; color: #c41e3a; line-height: 1.7; margin-bottom: 15px; flex: 1; display: flex; align-items: center; }
        .card-sign { font-size: 1.1rem; color: #c41e3a; }
        .card-from { font-size: 1rem; font-weight: 600; color: #c41e3a; margin-top: 5px; }

        .stickers-layer { position: absolute; inset: 0; pointer-events: none; overflow: hidden; }
        .placed-sticker { position: absolute; pointer-events: auto; cursor: move; user-select: none; transition: transform 0.2s; }
        .placed-sticker:active { transform: scale(1.2); }

        .card-hint { margin-top: 14px; font-size: 0.85rem; color: rgba(255,255,255,0.5); text-align: center; }
        .seal-btn { margin-top: 12px; padding: 10px 20px; border: none; border-radius: 25px; background: rgba(255,107,157,0.2); color: rgba(255,255,255,0.8); font-family: inherit; font-size: 0.85rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .seal-btn:hover { background: rgba(255,107,157,0.35); transform: scale(1.05); }
        .seal-btn:active { transform: scale(0.95); }

        /* Reply Button - Appears in view mode */
        .reply-btn { display: none; margin-top: 20px; padding: 14px 28px; border: none; border-radius: 30px; background: linear-gradient(135deg, rgba(255,107,157,0.3), rgba(255,23,68,0.3)); color: rgba(255,255,255,0.9); font-family: 'Dancing Script', cursive; font-size: 1.1rem; cursor: pointer; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); opacity: 0; animation: none; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .reply-btn.visible { display: inline-block; animation: replyFadeIn 1s ease 0.5s forwards; }
        .reply-btn:hover { background: linear-gradient(135deg, rgba(255,107,157,0.5), rgba(255,23,68,0.5)); transform: scale(1.05); }
        .reply-btn:active { transform: scale(0.95); }
        @keyframes replyFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Font classes */
        .font-dancing { font-family: 'Dancing Script', cursive; }
        .font-pacifico { font-family: 'Pacifico', cursive; }
        .font-lobster { font-family: 'Lobster', cursive; }
        .font-great-vibes { font-family: 'Great Vibes', cursive; }
        .font-quicksand { font-family: 'Quicksand', sans-serif; }

        /* Editor */
        .editor { background: rgba(255,255,255,0.06); border-radius: 24px; padding: 20px; backdrop-filter: blur(10px); opacity: 0; animation: fadeSlideUp 0.8s ease 0.6s forwards; }
        .tabs { display: flex; gap: 6px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { flex: 1; min-width: 70px; padding: 12px 8px; border: none; border-radius: 12px; background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.6); font-family: inherit; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .tab:hover { background: rgba(255,255,255,0.12); }
        .tab.active { background: linear-gradient(135deg, #ff1744, #ff6b9d); color: #fff; transform: scale(1.02); box-shadow: 0 4px 15px rgba(255,23,68,0.4); }

        .panel { display: none; }
        .panel.active { display: block; animation: panelFadeIn 0.4s ease; }
        @keyframes panelFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Form */
        .field { margin-bottom: 16px; }
        .field label { display: block; font-size: 0.8rem; color: #ffb6c1; margin-bottom: 8px; font-weight: 600; }
        .field input, .field textarea { width: 100%; padding: 14px; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(255,255,255,0.06); color: #fff; font-family: inherit; font-size: 1rem; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .field input:focus, .field textarea:focus { outline: none; border-color: #ff6b9d; background: rgba(255,255,255,0.1); box-shadow: 0 0 25px rgba(255,107,157,0.3), inset 0 0 15px rgba(255,107,157,0.05); transform: scale(1.01); }
        .field input:hover:not(:focus), .field textarea:hover:not(:focus) { border-color: rgba(255,107,157,0.3); background: rgba(255,255,255,0.08); }
        .field textarea { resize: none; min-height: 90px; }
        .field-row { display: flex; gap: 12px; }
        .field-row .field { flex: 1; }

        /* Sections */
        .section-title { font-size: 0.85rem; color: #ffb6c1; margin-bottom: 12px; font-weight: 600; }
        .hint { font-size: 0.75rem; color: rgba(255,255,255,0.4); margin-bottom: 10px; }

        /* Grids */
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
        .grid-6 { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 15px; }

        /* Buttons */
        .color-btn { aspect-ratio: 1; border: 3px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .color-btn:hover { transform: scale(1.1); }
        .color-btn.active { border-color: #fff; transform: scale(1.15); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        .emoji-btn, .sticker-btn { aspect-ratio: 1; border: 2px solid transparent; border-radius: 12px; background: rgba(255,255,255,0.08); font-size: 1.4rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .emoji-btn:hover, .sticker-btn:hover { transform: scale(1.1); background: rgba(255,255,255,0.15); }
        .emoji-btn.active, .seal-emoji-btn.active { border-color: #ff6b9d; background: rgba(255,107,157,0.25); transform: scale(1.1); }
        .seal-emoji-btn { aspect-ratio: 1; border: 2px solid transparent; border-radius: 12px; background: rgba(255,255,255,0.08); font-size: 1.4rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .seal-emoji-btn:hover { transform: scale(1.1); background: rgba(255,255,255,0.15); }
        .sticker-btn:active { transform: scale(1.2); background: rgba(255,107,157,0.4); }

        .font-btn { padding: 12px; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; background: transparent; color: #fff; font-size: 0.9rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .font-btn:hover { background: rgba(255,255,255,0.08); }
        .font-btn.active { border-color: #ff6b9d; background: rgba(255,107,157,0.2); transform: scale(1.02); }

        .quick-btn { padding: 12px 16px; border: none; border-radius: 25px; background: rgba(255,107,157,0.2); color: #fff; font-family: inherit; font-size: 0.85rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .quick-btn:hover { background: rgba(255,107,157,0.35); transform: scale(1.02); }
        .quick-btn:active { transform: scale(0.95); }

        .clear-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; background: rgba(255,100,100,0.15); color: #ff6b6b; font-family: inherit; font-size: 0.85rem; cursor: pointer; transition: all 0.3s; }
        .clear-btn:hover { background: rgba(255,100,100,0.25); }

        /* Range Slider */
        .slider-row { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .slider-row label { font-size: 0.8rem; color: #ffb6c1; min-width: 80px; }
        .slider-row input[type="range"] { flex: 1; height: 6px; border-radius: 3px; background: rgba(255,255,255,0.15); -webkit-appearance: none; }
        .slider-row input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, #ff6b9d, #ff1744); cursor: pointer; box-shadow: 0 2px 10px rgba(255,107,157,0.5); transition: transform 0.2s; }
        .slider-row input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* Share Button */
        .share-btn { position: fixed; bottom: 20px; left: 20px; right: 20px; max-width: 460px; margin: 0 auto; padding: 18px; border: none; border-radius: 50px; background: linear-gradient(135deg, #ff1744, #ff6b9d); color: #fff; font-family: inherit; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 8px 30px rgba(255,23,68,0.5); display: flex; align-items: center; justify-content: center; gap: 10px; z-index: 100; opacity: 0; animation: fadeSlideUp 0.8s ease 0.8s forwards; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .share-btn:hover { transform: scale(1.02); box-shadow: 0 12px 40px rgba(255,23,68,0.6); }
        .share-btn:active { transform: scale(0.98); }
        .share-btn.saving { animation: savingPulse 1s ease infinite; }
        @keyframes savingPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0); display: none; align-items: flex-end; justify-content: center; z-index: 1000; transition: background 0.3s; }
        .modal.active { display: flex; background: rgba(0,0,0,0.85); }
        .modal-box { width: 100%; max-width: 400px; background: linear-gradient(180deg, #1a1a2e, #16213e); border-radius: 28px 28px 0 0; padding: 28px; padding-bottom: 40px; position: relative; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal.active .modal-box { transform: translateY(0); }
        .modal-close { position: absolute; top: 18px; right: 18px; width: 38px; height: 38px; border: none; border-radius: 50%; background: rgba(255,255,255,0.1); color: #fff; font-size: 1.5rem; cursor: pointer; transition: all 0.3s; }
        .modal-close:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
        .modal h2 { text-align: center; font-size: 1.4rem; margin-bottom: 20px; }
        .share-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .share-item { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 14px 8px; border: none; border-radius: 16px; background: rgba(255,255,255,0.08); color: #fff; font-family: inherit; font-size: 0.75rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .share-item span { font-size: 1.8rem; }
        .share-item:hover { background: rgba(255,107,157,0.25); transform: scale(1.05); }
        .share-item:active { transform: scale(0.95); }

        .link-section { border-top: 1px solid rgba(255,255,255,0.1); padding-top: 18px; }
        .link-section p { font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 10px; }
        .link-row { display: flex; gap: 10px; }
        .link-row input { flex: 1; padding: 12px; border: none; border-radius: 10px; background: rgba(255,255,255,0.1); color: #fff; font-family: inherit; font-size: 0.85rem; }
        .link-row button { padding: 12px 20px; border: none; border-radius: 10px; background: linear-gradient(135deg, #ff1744, #d50000); color: #fff; font-family: inherit; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .link-row button:hover { transform: scale(1.05); }

        .card-id { text-align: center; margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; }
        .card-id code { font-size: 1.2rem; color: #ff6b9d; letter-spacing: 3px; }

        /* Toast */
        .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(60px); background: linear-gradient(135deg, #00c853, #69f0ae); color: #fff; padding: 14px 28px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; opacity: 0; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 2000; pointer-events: none; white-space: nowrap; box-shadow: 0 8px 25px rgba(0,200,83,0.4); }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Immersive View Mode */
        .immersive-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f1e 100%); background-size: 400% 400%; animation: ambientFlow 15s ease infinite; z-index: 500; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .immersive-overlay.active { display: flex; animation: immersiveFadeIn 0.6s ease; }
        @keyframes immersiveFadeIn { from { opacity: 0; } to { opacity: 1; } }

        .immersive-card { width: 300px; height: 420px; perspective: 1200px; cursor: pointer; }
        .immersive-card .card-inner { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .immersive-card.flipped .card-inner { transform: rotateY(180deg); }
        .immersive-card .card-face { position: absolute; top: 0; left: 0; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; border-radius: 20px; overflow: hidden; box-shadow: 0 25px 60px rgba(0,0,0,0.6); }
        .immersive-card .card-front { background: linear-gradient(135deg, var(--card-color1, #ff1744), var(--card-color2, #d50000)); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; position: relative; }
        .immersive-card .card-front::before { content: ''; position: absolute; inset: 14px; border: 2px solid rgba(255,255,255,0.3); border-radius: 14px; }
        .immersive-card .card-emoji { font-size: 4.5rem; margin-bottom: 20px; animation: emojiEntrance 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s backwards; }
        @keyframes emojiEntrance { 0% { opacity: 0; transform: scale(0) rotate(-30deg); } 100% { opacity: 1; transform: scale(1) rotate(0); } }
        .immersive-card .card-title { font-size: 1.8rem; color: #fff; text-align: center; text-shadow: 0 3px 12px rgba(0,0,0,0.4); line-height: 1.3; }
        .immersive-card .card-back { background: linear-gradient(180deg, #fff5f5, #ffe4e9); transform: rotateY(180deg); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .immersive-card .card-to { font-size: 1rem; color: #c41e3a; margin-bottom: 10px; opacity: 0; }
        .immersive-card .card-to span { font-size: 1.5rem; }
        .immersive-card .card-msg { font-size: 1.05rem; color: #c41e3a; line-height: 1.8; margin-bottom: 20px; flex: 1; display: flex; align-items: center; opacity: 0; }
        .immersive-card .card-sign { font-size: 1.2rem; color: #c41e3a; opacity: 0; }
        .immersive-card .card-from { font-size: 1.1rem; font-weight: 600; color: #c41e3a; margin-top: 8px; opacity: 0; }

        /* Cinematic text reveal animation */
        .immersive-card.flipped .card-to { animation: textReveal 0.6s ease 0.3s forwards; }
        .immersive-card.flipped .card-msg { animation: textReveal 0.8s ease 0.6s forwards; }
        .immersive-card.flipped .card-sign { animation: textReveal 0.5s ease 1.2s forwards; }
        .immersive-card.flipped .card-from { animation: textReveal 0.5s ease 1.5s forwards; }
        @keyframes textReveal {
            0% { opacity: 0; transform: translateY(15px); filter: blur(4px); }
            100% { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        .immersive-hint { margin-top: 25px; font-size: 0.9rem; color: rgba(255,255,255,0.5); text-align: center; animation: pulse 2s ease infinite; }

        .immersive-reply { margin-top: 30px; opacity: 0; transform: translateY(15px); transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .immersive-reply.visible { opacity: 1; transform: translateY(0); }
        .immersive-reply button { padding: 16px 32px; border: none; border-radius: 30px; background: linear-gradient(135deg, rgba(255,107,157,0.3), rgba(255,23,68,0.3)); color: rgba(255,255,255,0.9); font-family: 'Dancing Script', cursive; font-size: 1.2rem; cursor: pointer; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.15); }
        .immersive-reply button:hover { background: linear-gradient(135deg, rgba(255,107,157,0.5), rgba(255,23,68,0.5)); transform: scale(1.05); }
        .immersive-reply p { font-size: 0.8rem; color: rgba(255,255,255,0.4); margin-top: 10px; }

        /* Desktop */
        @media (min-width: 600px) {
            .envelope { width: 300px; height: 195px; }
            .card { width: 300px; height: 420px; }
            .card-emoji { font-size: 4.2rem; }
            .card-title { font-size: 1.9rem; }
            .immersive-card { width: 340px; height: 480px; }
            .immersive-card .card-emoji { font-size: 5rem; }
            .immersive-card .card-title { font-size: 2rem; }
            .modal { align-items: center; }
            .modal-box { border-radius: 28px; margin: 20px; }
        }
    </style>
</head>
<body>
    <div class="ambient-bg"></div>

    <!-- Floating Hearts Background -->
    <div class="floating-hearts">
        <div class="heart">üíï</div>
        <div class="heart">‚ù§Ô∏è</div>
        <div class="heart">üíñ</div>
        <div class="heart">üíó</div>
        <div class="heart">üíò</div>
        <div class="heart">üíù</div>
        <div class="heart">üíì</div>
        <div class="heart">üíû</div>
        <div class="heart">üíï</div>
        <div class="heart">‚ù§Ô∏è</div>
    </div>

    <!-- Sparkles -->
    <div class="sparkles">
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
    </div>

    <div class="app" id="app">
        <header class="header">
            <h1>NOTE2U</h1>
            <p>Create & Share Valentine Cards</p>
        </header>

        <div class="card-area">
            <!-- Envelope -->
            <div class="envelope" id="envelope">
                <div class="envelope-back"></div>
                <div class="envelope-flap"></div>
                <div class="seal" id="envSeal">üíù</div>
                <div class="envelope-front"><p>To: <span id="envTo">My Love</span></p></div>
            </div>
            <p class="tap-hint" id="tapHint">Tap to open</p>

            <!-- Card (hidden initially) -->
            <div class="card-wrapper" id="cardWrapper">
                <div class="card" id="card">
                    <div class="card-inner">
                        <div class="card-face card-front" id="cardFront">
                            <div class="card-emoji" id="cardEmoji">üíï</div>
                            <p class="card-title font-dancing" id="cardTitle">Will You Be My Valentine?</p>
                            <div class="stickers-layer" id="stickersFront"></div>
                        </div>
                        <div class="card-face card-back">
                            <p class="card-to">To: <span class="font-dancing" id="cardTo">My Love</span></p>
                            <p class="card-msg" id="cardMsg">Write something sweet...</p>
                            <p class="card-sign font-dancing" id="cardSign">Forever Yours,</p>
                            <p class="card-from" id="cardFrom">Your Name</p>
                            <div class="stickers-layer" id="stickersBack"></div>
                        </div>
                    </div>
                </div>
                <p class="card-hint">Tap card to flip</p>
                <button class="seal-btn" id="sealBtn">Put back in envelope</button>
                <button class="reply-btn" id="replyBtn">Your turn.</button>
            </div>
        </div>

        <div class="editor" id="editor">
            <div class="tabs">
                <button class="tab active" data-tab="write">Write</button>
                <button class="tab" data-tab="style">Style</button>
                <button class="tab" data-tab="font">Font</button>
                <button class="tab" data-tab="decorate">Decorate</button>
            </div>

            <!-- Write Panel -->
            <div class="panel active" id="writePanel">
                <div class="field">
                    <label>To (recipient)</label>
                    <input type="text" id="inputTo" placeholder="Their name" maxlength="30">
                </div>
                <div class="field">
                    <label>Front Message</label>
                    <input type="text" id="inputTitle" placeholder="Will You Be My Valentine?" maxlength="60">
                </div>
                <div class="field">
                    <label>Your Message Inside</label>
                    <textarea id="inputMsg" placeholder="Write something sweet..." maxlength="500"></textarea>
                </div>
                <div class="field-row">
                    <div class="field">
                        <label>Sign Off</label>
                        <input type="text" id="inputSign" placeholder="Forever Yours," maxlength="30">
                    </div>
                    <div class="field">
                        <label>From</label>
                        <input type="text" id="inputFrom" placeholder="Your name" maxlength="30">
                    </div>
                </div>
                <p class="section-title" style="margin-top:15px">Quick Templates</p>
                <div style="display:flex;flex-wrap:wrap;gap:8px">
                    <button class="quick-btn" data-t="Be Mine!" data-m="You stole my heart and I never want it back.">Classic</button>
                    <button class="quick-btn" data-t="I Love You!" data-m="Every moment with you feels like a beautiful dream. You mean everything to me.">Sweet</button>
                    <button class="quick-btn" data-t="Hey You!" data-m="You're weird. I like it. Let's be weird together forever?">Funny</button>
                    <button class="quick-btn" data-t="My Soulmate" data-m="In you, I found my best friend and my forever love. Happy Valentine's Day!">Romantic</button>
                    <button class="quick-btn" data-t="You + Me" data-m="Like coffee and mornings, we just belong together. Be my Valentine?">Cute</button>
                    <button class="quick-btn" data-t="Forever & Always" data-m="My heart knew you were the one from the very first moment. I love you endlessly.">Deep</button>
                    <button class="quick-btn" data-t="To My Love" data-m="You make ordinary days feel magical. Thank you for being you.">Simple</button>
                    <button class="quick-btn" data-t="Crazy About You" data-m="I fall for you a little more every single day. You're my favorite person!">Playful</button>
                </div>
            </div>

            <!-- Style Panel -->
            <div class="panel" id="stylePanel">
                <p class="section-title">Card Color</p>
                <div class="grid-4">
                    <!-- Classic Love -->
                    <button class="color-btn active" data-c1="#ff1744" data-c2="#d50000" style="background:linear-gradient(135deg,#ff1744,#d50000)"></button>
                    <button class="color-btn" data-c1="#ff80ab" data-c2="#f48fb1" style="background:linear-gradient(135deg,#ff80ab,#f48fb1)"></button>
                    <button class="color-btn" data-c1="#e91e63" data-c2="#ad1457" style="background:linear-gradient(135deg,#e91e63,#ad1457)"></button>
                    <button class="color-btn" data-c1="#ff6b9d" data-c2="#ff1744" style="background:linear-gradient(135deg,#ff6b9d,#ff1744)"></button>
                    <!-- Pastels -->
                    <button class="color-btn" data-c1="#ffb6c1" data-c2="#ffc0cb" style="background:linear-gradient(135deg,#ffb6c1,#ffc0cb)"></button>
                    <button class="color-btn" data-c1="#dda0dd" data-c2="#e6b3e6" style="background:linear-gradient(135deg,#dda0dd,#e6b3e6)"></button>
                    <button class="color-btn" data-c1="#b0e0e6" data-c2="#add8e6" style="background:linear-gradient(135deg,#b0e0e6,#add8e6)"></button>
                    <button class="color-btn" data-c1="#ffe4e1" data-c2="#fff0f5" style="background:linear-gradient(135deg,#ffe4e1,#fff0f5)"></button>
                    <!-- Rich Colors -->
                    <button class="color-btn" data-c1="#9c27b0" data-c2="#7b1fa2" style="background:linear-gradient(135deg,#9c27b0,#7b1fa2)"></button>
                    <button class="color-btn" data-c1="#673ab7" data-c2="#512da8" style="background:linear-gradient(135deg,#673ab7,#512da8)"></button>
                    <button class="color-btn" data-c1="#2196f3" data-c2="#1565c0" style="background:linear-gradient(135deg,#2196f3,#1565c0)"></button>
                    <button class="color-btn" data-c1="#00bcd4" data-c2="#00838f" style="background:linear-gradient(135deg,#00bcd4,#00838f)"></button>
                    <!-- Warm & Gold -->
                    <button class="color-btn" data-c1="#ffd700" data-c2="#ffb300" style="background:linear-gradient(135deg,#ffd700,#ffb300)"></button>
                    <button class="color-btn" data-c1="#ff9800" data-c2="#e65100" style="background:linear-gradient(135deg,#ff9800,#e65100)"></button>
                    <button class="color-btn" data-c1="#ff5722" data-c2="#d84315" style="background:linear-gradient(135deg,#ff5722,#d84315)"></button>
                    <button class="color-btn" data-c1="#e91e63" data-c2="#ff5722" style="background:linear-gradient(135deg,#e91e63,#ff5722)"></button>
                    <!-- Neon & Electric -->
                    <button class="color-btn" data-c1="#ff0080" data-c2="#7928ca" style="background:linear-gradient(135deg,#ff0080,#7928ca)"></button>
                    <button class="color-btn" data-c1="#00ff87" data-c2="#60efff" style="background:linear-gradient(135deg,#00ff87,#60efff)"></button>
                    <button class="color-btn" data-c1="#f093fb" data-c2="#f5576c" style="background:linear-gradient(135deg,#f093fb,#f5576c)"></button>
                    <button class="color-btn" data-c1="#4facfe" data-c2="#00f2fe" style="background:linear-gradient(135deg,#4facfe,#00f2fe)"></button>
                    <!-- Elegant -->
                    <button class="color-btn" data-c1="#c9a227" data-c2="#8b6914" style="background:linear-gradient(135deg,#c9a227,#8b6914)"></button>
                    <button class="color-btn" data-c1="#c0c0c0" data-c2="#808080" style="background:linear-gradient(135deg,#c0c0c0,#808080)"></button>
                    <button class="color-btn" data-c1="#b76e79" data-c2="#8b4557" style="background:linear-gradient(135deg,#b76e79,#8b4557)"></button>
                    <button class="color-btn" data-c1="#2c3e50" data-c2="#1a252f" style="background:linear-gradient(135deg,#2c3e50,#1a252f)"></button>
                </div>

                <p class="section-title">Card Emoji</p>
                <div class="grid-5">
                    <button class="emoji-btn active" data-e="üíï">üíï</button>
                    <button class="emoji-btn" data-e="‚ù§Ô∏è">‚ù§Ô∏è</button>
                    <button class="emoji-btn" data-e="üíñ">üíñ</button>
                    <button class="emoji-btn" data-e="üíù">üíù</button>
                    <button class="emoji-btn" data-e="üíò">üíò</button>
                    <button class="emoji-btn" data-e="üíó">üíó</button>
                    <button class="emoji-btn" data-e="üíì">üíì</button>
                    <button class="emoji-btn" data-e="üíû">üíû</button>
                    <button class="emoji-btn" data-e="üíü">üíü</button>
                    <button class="emoji-btn" data-e="‚ù£Ô∏è">‚ù£Ô∏è</button>
                    <button class="emoji-btn" data-e="ü•∞">ü•∞</button>
                    <button class="emoji-btn" data-e="üòç">üòç</button>
                    <button class="emoji-btn" data-e="üòò">üòò</button>
                    <button class="emoji-btn" data-e="ü§ó">ü§ó</button>
                    <button class="emoji-btn" data-e="ü•∫">ü•∫</button>
                    <button class="emoji-btn" data-e="üåπ">üåπ</button>
                    <button class="emoji-btn" data-e="üå∏">üå∏</button>
                    <button class="emoji-btn" data-e="üå∫">üå∫</button>
                    <button class="emoji-btn" data-e="ü¶ã">ü¶ã</button>
                    <button class="emoji-btn" data-e="‚ú®">‚ú®</button>
                </div>

                <p class="section-title">Envelope Seal</p>
                <div class="grid-5">
                    <button class="seal-emoji-btn active" data-s="üíù">üíù</button>
                    <button class="seal-emoji-btn" data-s="üíå">üíå</button>
                    <button class="seal-emoji-btn" data-s="üíï">üíï</button>
                    <button class="seal-emoji-btn" data-s="‚ù§Ô∏è">‚ù§Ô∏è</button>
                    <button class="seal-emoji-btn" data-s="üíñ">üíñ</button>
                    <button class="seal-emoji-btn" data-s="üíò">üíò</button>
                    <button class="seal-emoji-btn" data-s="üíó">üíó</button>
                    <button class="seal-emoji-btn" data-s="üíû">üíû</button>
                    <button class="seal-emoji-btn" data-s="ü•∞">ü•∞</button>
                    <button class="seal-emoji-btn" data-s="üòò">üòò</button>
                    <button class="seal-emoji-btn" data-s="üåπ">üåπ</button>
                    <button class="seal-emoji-btn" data-s="üå∏">üå∏</button>
                    <button class="seal-emoji-btn" data-s="ü¶ã">ü¶ã</button>
                    <button class="seal-emoji-btn" data-s="‚ú®">‚ú®</button>
                    <button class="seal-emoji-btn" data-s="üéÄ">üéÄ</button>
                </div>
            </div>

            <!-- Font Panel -->
            <div class="panel" id="fontPanel">
                <p class="section-title">Title Font</p>
                <div class="grid-4" style="margin-bottom:15px">
                    <button class="font-btn active" data-font="font-dancing" style="font-family:'Dancing Script'">Elegant</button>
                    <button class="font-btn" data-font="font-pacifico" style="font-family:'Pacifico'">Pacifico</button>
                    <button class="font-btn" data-font="font-lobster" style="font-family:'Lobster'">Lobster</button>
                    <button class="font-btn" data-font="font-great-vibes" style="font-family:'Great Vibes'">Vibes</button>
                </div>

                <p class="section-title">Title Size</p>
                <div class="slider-row">
                    <label>Size</label>
                    <input type="range" id="titleSize" min="1" max="2.2" step="0.1" value="1.5">
                </div>

                <p class="section-title">Message Size</p>
                <div class="slider-row">
                    <label>Size</label>
                    <input type="range" id="msgSize" min="0.75" max="1.3" step="0.05" value="0.95">
                </div>
            </div>

            <!-- Decorate Panel -->
            <div class="panel" id="decoratePanel">
                <p class="section-title">Add Stickers</p>
                <p class="hint">Tap to add - Drag to move - Long press to remove</p>
                <div class="grid-6">
                    <button class="sticker-btn" data-s="‚ù§Ô∏è">‚ù§Ô∏è</button>
                    <button class="sticker-btn" data-s="üíï">üíï</button>
                    <button class="sticker-btn" data-s="üíñ">üíñ</button>
                    <button class="sticker-btn" data-s="üíó">üíó</button>
                    <button class="sticker-btn" data-s="üíò">üíò</button>
                    <button class="sticker-btn" data-s="üíù">üíù</button>
                    <button class="sticker-btn" data-s="üíì">üíì</button>
                    <button class="sticker-btn" data-s="üíû">üíû</button>
                    <button class="sticker-btn" data-s="üíü">üíü</button>
                    <button class="sticker-btn" data-s="‚ù£Ô∏è">‚ù£Ô∏è</button>
                    <button class="sticker-btn" data-s="üåπ">üåπ</button>
                    <button class="sticker-btn" data-s="üå∏">üå∏</button>
                    <button class="sticker-btn" data-s="üå∫">üå∫</button>
                    <button class="sticker-btn" data-s="üå∑">üå∑</button>
                    <button class="sticker-btn" data-s="ü¶ã">ü¶ã</button>
                    <button class="sticker-btn" data-s="üêª">üêª</button>
                    <button class="sticker-btn" data-s="üß∏">üß∏</button>
                    <button class="sticker-btn" data-s="‚ú®">‚ú®</button>
                    <button class="sticker-btn" data-s="‚≠ê">‚≠ê</button>
                    <button class="sticker-btn" data-s="üåü">üåü</button>
                    <button class="sticker-btn" data-s="üí´">üí´</button>
                    <button class="sticker-btn" data-s="üéÄ">üéÄ</button>
                    <button class="sticker-btn" data-s="üíå">üíå</button>
                    <button class="sticker-btn" data-s="üç´">üç´</button>
                    <button class="sticker-btn" data-s="üç∞">üç∞</button>
                    <button class="sticker-btn" data-s="üç≠">üç≠</button>
                    <button class="sticker-btn" data-s="üíã">üíã</button>
                    <button class="sticker-btn" data-s="üëë">üëë</button>
                    <button class="sticker-btn" data-s="ü•∞">ü•∞</button>
                    <button class="sticker-btn" data-s="üòç">üòç</button>
                    <button class="sticker-btn" data-s="üòò">üòò</button>
                    <button class="sticker-btn" data-s="ü§ó">ü§ó</button>
                    <button class="sticker-btn" data-s="ü•∫">ü•∫</button>
                    <button class="sticker-btn" data-s="üôà">üôà</button>
                    <button class="sticker-btn" data-s="üíë">üíë</button>
                    <button class="sticker-btn" data-s="üë´">üë´</button>
                </div>

                <p class="section-title">Sticker Size</p>
                <div class="slider-row">
                    <label>Size</label>
                    <input type="range" id="stickerSize" min="1" max="3" step="0.25" value="1.5">
                </div>

                <button class="clear-btn" id="clearStickers">Clear All Stickers</button>
            </div>
        </div>

        <button class="share-btn" id="shareBtn">Share Your Card</button>
    </div>

    <!-- Immersive View Overlay -->
    <div class="immersive-overlay" id="immersiveOverlay">
        <div class="immersive-card" id="immersiveCard">
            <div class="card-inner">
                <div class="card-face card-front" id="immersiveFront">
                    <div class="card-emoji" id="immersiveEmoji">üíï</div>
                    <p class="card-title font-dancing" id="immersiveTitle">Will You Be My Valentine?</p>
                    <div class="stickers-layer" id="immersiveStickersFront"></div>
                </div>
                <div class="card-face card-back">
                    <p class="card-to">To: <span class="font-dancing" id="immersiveTo">My Love</span></p>
                    <p class="card-msg" id="immersiveMsg">Write something sweet...</p>
                    <p class="card-sign font-dancing" id="immersiveSign">Forever Yours,</p>
                    <p class="card-from" id="immersiveFrom">Your Name</p>
                    <div class="stickers-layer" id="immersiveStickersBack"></div>
                </div>
            </div>
        </div>
        <p class="immersive-hint" id="immersiveHint">Tap to flip</p>
        <div class="immersive-reply" id="immersiveReply">
            <button id="immersiveReplyBtn">Your turn.</button>
            <p>Reply with a card</p>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-box">
            <button class="modal-close" id="modalClose">√ó</button>
            <h2>Share Your Card</h2>
            <div class="card-id">
                <p style="font-size:0.75rem;color:rgba(255,255,255,0.5);margin-bottom:5px">Your Card ID</p>
                <code id="cardIdDisplay">------</code>
            </div>
            <div class="share-grid" style="margin-top:20px">
                <button class="share-item" id="shareNative"><span>üì§</span>Share</button>
                <button class="share-item" id="shareWhatsApp"><span>üí¨</span>WhatsApp</button>
                <button class="share-item" id="shareSMS"><span>üì±</span>SMS</button>
                <button class="share-item" id="shareEmail"><span>üìß</span>Email</button>
            </div>
            <div class="link-section">
                <p>Or copy link:</p>
                <div class="link-row">
                    <input type="text" id="linkInput" readonly>
                    <button id="copyLink">Copy</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // State
        let state = {
            to: '', title: '', msg: '', sign: '', from: '',
            color1: '#ff1744', color2: '#d50000',
            emoji: 'üíï', sealEmoji: 'üíù', font: 'font-dancing',
            titleSize: 1.5, msgSize: 0.95, stickerSize: 1.5,
            stickers: []
        };
        let isFlipped = false;
        let cardId = null;
        let envelopeOpened = false;
        let viewOnly = false;
        let originalSender = null;
        let receivedCardStyle = null;

        // Generate short ID
        function generateId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let id = '';
            for (let i = 0; i < 6; i++) id += chars[Math.floor(Math.random() * chars.length)];
            return id;
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const sharedId = params.get('id') || params.get('card');
            const isReply = params.get('reply') === '1';

            if (sharedId && !isReply) {
                // Viewing a shared card - immersive mode
                viewOnly = true;
                document.getElementById('app').style.display = 'none';

                if (sharedId.length === 6) {
                    loadCardById(sharedId, true);
                } else {
                    loadCardFromData(sharedId, true);
                }
            } else if (isReply) {
                // Reply mode - show editor with pre-filled style
                const replyTo = params.get('to');
                const c1 = params.get('c1');
                const c2 = params.get('c2');

                if (replyTo) {
                    document.getElementById('inputTo').value = replyTo;
                    document.getElementById('cardTo').textContent = replyTo;
                    document.getElementById('envTo').textContent = replyTo;
                    state.to = replyTo;
                }

                if (c1 && c2) {
                    state.color1 = c1;
                    state.color2 = c2;
                    applyColors(c1, c2);
                }

                initAll();
                toast('Create your reply card!');
            } else {
                initAll();
            }
        });

        function initAll() {
            initEnvelope();
            initCard();
            initTabs();
            initInputs();
            initQuickBtns();
            initColors();
            initEmojis();
            initFonts();
            initSizes();
            initStickers();
            initShare();
            initReply();
        }

        // Apply colors helper
        function applyColors(c1, c2) {
            document.getElementById('cardFront').style.setProperty('--card-color1', c1);
            document.getElementById('cardFront').style.setProperty('--card-color2', c2);
            document.querySelector('.envelope-back').style.background = `linear-gradient(180deg, ${c1}, ${c2})`;
            document.querySelector('.envelope-front').style.background = `linear-gradient(180deg, ${c1}, ${adjustColor(c1, 20)})`;
            document.querySelector('.envelope-flap').style.background = `linear-gradient(135deg, ${c1}, ${c2})`;
        }

        // Envelope
        function initEnvelope() {
            document.getElementById('envelope').addEventListener('click', openEnvelope);
            document.getElementById('sealBtn').addEventListener('click', closeEnvelope);
        }

        function openEnvelope() {
            if (envelopeOpened) return;
            envelopeOpened = true;

            const env = document.getElementById('envelope');
            env.classList.add('opening');
            document.getElementById('tapHint').style.display = 'none';

            setTimeout(() => {
                env.classList.add('hidden');
                document.getElementById('cardWrapper').classList.add('visible');
            }, 900);
        }

        function closeEnvelope() {
            envelopeOpened = false;
            const env = document.getElementById('envelope');
            const card = document.getElementById('card');

            card.classList.remove('flipped');
            isFlipped = false;

            document.getElementById('cardWrapper').classList.remove('visible');
            env.classList.remove('hidden');
            env.classList.remove('opening');
            document.getElementById('tapHint').style.display = 'block';
        }

        // Card flip
        function initCard() {
            document.getElementById('card').addEventListener('click', () => {
                document.getElementById('card').classList.toggle('flipped');
                isFlipped = !isFlipped;
            });
        }

        // Tabs
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + 'Panel').classList.add('active');
                });
            });
        }

        // Inputs
        function initInputs() {
            const inputs = [
                ['inputTo', 'cardTo', 'envTo', 'to', 'My Love'],
                ['inputTitle', 'cardTitle', null, 'title', 'Will You Be My Valentine?'],
                ['inputMsg', 'cardMsg', null, 'msg', 'Write something sweet...'],
                ['inputSign', 'cardSign', null, 'sign', 'Forever Yours,'],
                ['inputFrom', 'cardFrom', null, 'from', 'Your Name']
            ];

            inputs.forEach(([inputId, cardId, envId, stateKey, placeholder]) => {
                document.getElementById(inputId).addEventListener('input', e => {
                    state[stateKey] = e.target.value;
                    const el = document.getElementById(cardId);
                    if (stateKey === 'msg') {
                        el.innerHTML = (e.target.value || placeholder).replace(/\n/g, '<br>');
                    } else {
                        el.textContent = e.target.value || placeholder;
                    }
                    if (envId) document.getElementById(envId).textContent = e.target.value || placeholder;
                });
            });
        }

        // Quick buttons
        function initQuickBtns() {
            document.querySelectorAll('.quick-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('inputTitle').value = btn.dataset.t;
                    document.getElementById('inputMsg').value = btn.dataset.m;
                    document.getElementById('cardTitle').textContent = btn.dataset.t;
                    document.getElementById('cardMsg').textContent = btn.dataset.m;
                    state.title = btn.dataset.t;
                    state.msg = btn.dataset.m;
                    toast('Template applied!');
                });
            });
        }

        // Colors
        function initColors() {
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.color1 = btn.dataset.c1;
                    state.color2 = btn.dataset.c2;
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    applyColors(state.color1, state.color2);
                });
            });
        }

        function adjustColor(hex, amt) {
            let num = parseInt(hex.slice(1), 16);
            let r = Math.min(255, (num >> 16) + amt);
            let g = Math.min(255, ((num >> 8) & 0x00FF) + amt);
            let b = Math.min(255, (num & 0x0000FF) + amt);
            return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
        }

        // Emojis
        function initEmojis() {
            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.emoji = btn.dataset.e;
                    document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('cardEmoji').textContent = state.emoji;
                });
            });

            document.querySelectorAll('.seal-emoji-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.sealEmoji = btn.dataset.s;
                    document.querySelectorAll('.seal-emoji-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('envSeal').textContent = state.sealEmoji;
                });
            });
        }

        // Fonts
        function initFonts() {
            document.querySelectorAll('.font-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.font = btn.dataset.font;
                    document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('cardTitle').className = 'card-title ' + state.font;
                });
            });
        }

        // Sizes
        function initSizes() {
            document.getElementById('titleSize').addEventListener('input', e => {
                state.titleSize = e.target.value;
                document.getElementById('cardTitle').style.fontSize = state.titleSize + 'rem';
            });
            document.getElementById('msgSize').addEventListener('input', e => {
                state.msgSize = e.target.value;
                document.getElementById('cardMsg').style.fontSize = state.msgSize + 'rem';
            });
            document.getElementById('stickerSize').addEventListener('input', e => {
                state.stickerSize = e.target.value;
            });
        }

        // Stickers
        function initStickers() {
            document.querySelectorAll('.sticker-btn').forEach(btn => {
                btn.addEventListener('click', () => addSticker(btn.dataset.s));
            });
            document.getElementById('clearStickers').addEventListener('click', () => {
                document.getElementById('stickersFront').innerHTML = '';
                document.getElementById('stickersBack').innerHTML = '';
                state.stickers = [];
                toast('Stickers cleared');
            });
        }

        function addSticker(emoji) {
            const layer = document.getElementById(isFlipped ? 'stickersBack' : 'stickersFront');
            const el = document.createElement('div');
            el.className = 'placed-sticker';
            el.textContent = emoji;
            el.style.fontSize = state.stickerSize + 'rem';

            const x = 15 + Math.random() * 60;
            const y = 15 + Math.random() * 60;
            el.style.left = x + '%';
            el.style.top = y + '%';

            const stickerData = { emoji, x, y, size: state.stickerSize, side: isFlipped ? 'back' : 'front' };
            state.stickers.push(stickerData);

            let isDragging = false;
            let startX, startY, origX, origY;

            el.addEventListener('touchstart', e => {
                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                origX = parseFloat(el.style.left);
                origY = parseFloat(el.style.top);
            });

            el.addEventListener('touchmove', e => {
                if (!isDragging) return;
                e.preventDefault();
                const dx = (e.touches[0].clientX - startX) / layer.offsetWidth * 100;
                const dy = (e.touches[0].clientY - startY) / layer.offsetHeight * 100;
                el.style.left = Math.max(0, Math.min(90, origX + dx)) + '%';
                el.style.top = Math.max(0, Math.min(90, origY + dy)) + '%';
                stickerData.x = parseFloat(el.style.left);
                stickerData.y = parseFloat(el.style.top);
            });

            el.addEventListener('touchend', () => { isDragging = false; });

            let timer;
            el.addEventListener('touchstart', () => {
                timer = setTimeout(() => {
                    el.remove();
                    state.stickers = state.stickers.filter(s => s !== stickerData);
                    toast('Sticker removed');
                }, 600);
            });
            el.addEventListener('touchmove', () => clearTimeout(timer));
            el.addEventListener('touchend', () => clearTimeout(timer));

            layer.appendChild(el);
        }

        // Reply functionality
        function initReply() {
            document.getElementById('replyBtn').addEventListener('click', startReply);
            document.getElementById('immersiveReplyBtn').addEventListener('click', startReply);
        }

        function startReply() {
            const replyUrl = window.location.origin + window.location.pathname +
                '?reply=1' +
                (originalSender ? '&to=' + encodeURIComponent(originalSender) : '') +
                (receivedCardStyle ? '&c1=' + encodeURIComponent(receivedCardStyle.color1) + '&c2=' + encodeURIComponent(receivedCardStyle.color2) : '');
            window.location.href = replyUrl;
        }

        // Share
        function initShare() {
            const modal = document.getElementById('modal');

            document.getElementById('shareBtn').addEventListener('click', async () => {
                if (!cardId) {
                    cardId = generateId();
                }

                const cardData = { ...state, id: cardId };
                document.getElementById('cardIdDisplay').textContent = cardId;
                document.getElementById('linkInput').value = 'Saving...';
                document.getElementById('shareBtn').classList.add('saving');
                modal.classList.add('active');

                try {
                    const saveRes = await fetch('/.netlify/functions/save-card', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cardData)
                    });
                    if (!saveRes.ok) throw new Error('Save failed');
                    toast('Card saved!');
                } catch (e) {
                    console.error('Save error:', e);
                }

                document.getElementById('shareBtn').classList.remove('saving');
                const shareUrl = window.location.origin + window.location.pathname + '?id=' + cardId;
                document.getElementById('linkInput').value = shareUrl;
            });

            document.getElementById('modalClose').addEventListener('click', () => modal.classList.remove('active'));
            modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });

            if (navigator.share) {
                document.getElementById('shareNative').addEventListener('click', async () => {
                    try {
                        await navigator.share({ title: 'Valentine Card', text: getShareText(), url: document.getElementById('linkInput').value });
                        modal.classList.remove('active');
                    } catch (e) {}
                });
            } else {
                document.getElementById('shareNative').style.display = 'none';
            }

            document.getElementById('shareWhatsApp').addEventListener('click', () => {
                window.open('https://wa.me/?text=' + encodeURIComponent(getShareText() + '\n\n' + document.getElementById('linkInput').value), '_blank');
            });

            document.getElementById('shareSMS').addEventListener('click', () => {
                const text = getShareText() + ' ' + document.getElementById('linkInput').value;
                window.location.href = /iPad|iPhone|iPod/.test(navigator.userAgent) ? 'sms:&body=' + encodeURIComponent(text) : 'sms:?body=' + encodeURIComponent(text);
            });

            document.getElementById('shareEmail').addEventListener('click', () => {
                window.location.href = 'mailto:?subject=' + encodeURIComponent('Valentine Card for You!') + '&body=' + encodeURIComponent(getShareText() + '\n\n' + document.getElementById('linkInput').value);
            });

            document.getElementById('copyLink').addEventListener('click', () => {
                navigator.clipboard.writeText(document.getElementById('linkInput').value).then(() => toast('Link copied!'));
            });
        }

        function getShareText() {
            return (state.from || 'Someone special') + ' sent you a Valentine\'s card!';
        }

        // Load card by ID from server
        async function loadCardById(id, immersive = false) {
            try {
                const res = await fetch('/.netlify/functions/get-card?id=' + encodeURIComponent(id));
                if (res.ok) {
                    const data = await res.json();
                    if (immersive) {
                        showImmersiveCard(data);
                    } else {
                        applyCardData(data);
                    }
                } else {
                    toast('Card not found');
                }
            } catch (e) {
                console.error('Load error:', e);
                toast('Failed to load card');
            }
        }

        // Load card from encoded data (legacy)
        function loadCardFromData(encoded, immersive = false) {
            try {
                const data = JSON.parse(decodeURIComponent(atob(encoded)));
                if (immersive) {
                    showImmersiveCard(data);
                } else {
                    applyCardData(data);
                }
            } catch (e) {
                toast('Invalid card data');
            }
        }

        // Show immersive card view
        function showImmersiveCard(data) {
            const overlay = document.getElementById('immersiveOverlay');
            const card = document.getElementById('immersiveCard');

            // Store for reply
            originalSender = data.from || null;
            receivedCardStyle = { color1: data.color1 || '#ff1744', color2: data.color2 || '#d50000' };

            // Apply data to immersive card
            const toVal = data.to || 'My Love';
            const titleVal = data.title || 'Will You Be My Valentine?';
            const msgVal = data.msg || 'A special message for you...';
            const signVal = data.sign || 'Forever Yours,';
            const fromVal = data.from || 'Someone Special';

            document.getElementById('immersiveTo').textContent = toVal;
            document.getElementById('immersiveTitle').textContent = titleVal;
            document.getElementById('immersiveMsg').innerHTML = msgVal.replace(/\n/g, '<br>');
            document.getElementById('immersiveSign').textContent = signVal;
            document.getElementById('immersiveFrom').textContent = fromVal;

            if (data.color1 && data.color2) {
                document.getElementById('immersiveFront').style.setProperty('--card-color1', data.color1);
                document.getElementById('immersiveFront').style.setProperty('--card-color2', data.color2);
            }

            if (data.emoji) document.getElementById('immersiveEmoji').textContent = data.emoji;
            if (data.font) document.getElementById('immersiveTitle').className = 'card-title ' + data.font;
            if (data.titleSize) document.getElementById('immersiveTitle').style.fontSize = data.titleSize + 'rem';
            if (data.msgSize) document.getElementById('immersiveMsg').style.fontSize = data.msgSize + 'rem';

            // Add stickers
            if (data.stickers && data.stickers.length) {
                data.stickers.forEach(s => {
                    const layer = document.getElementById(s.side === 'back' ? 'immersiveStickersBack' : 'immersiveStickersFront');
                    const el = document.createElement('div');
                    el.className = 'placed-sticker';
                    el.textContent = s.emoji;
                    el.style.fontSize = (s.size || 1.5) + 'rem';
                    el.style.left = s.x + '%';
                    el.style.top = s.y + '%';
                    layer.appendChild(el);
                });
            }

            // Show overlay
            overlay.classList.add('active');

            // Wire up reply button for immersive view
            document.getElementById('immersiveReplyBtn').onclick = function() {
                const replyUrl = window.location.origin + window.location.pathname +
                    '?reply=1' +
                    (originalSender ? '&to=' + encodeURIComponent(originalSender) : '') +
                    '&c1=' + encodeURIComponent(receivedCardStyle.color1) +
                    '&c2=' + encodeURIComponent(receivedCardStyle.color2);
                window.location.href = replyUrl;
            };

            // Card flip interaction
            let immersiveFlipped = false;
            card.onclick = function() {
                card.classList.toggle('flipped');
                immersiveFlipped = !immersiveFlipped;

                // Show reply button after first flip
                if (immersiveFlipped) {
                    document.getElementById('immersiveHint').style.display = 'none';
                    setTimeout(() => {
                        document.getElementById('immersiveReply').classList.add('visible');
                    }, 800);
                }
            };
        }

        // Apply card data to editor view
        function applyCardData(data) {
            const toVal = data.to || 'My Love';
            const titleVal = data.title || 'Will You Be My Valentine?';
            const msgVal = data.msg || 'A special message for you...';
            const signVal = data.sign || 'Forever Yours,';
            const fromVal = data.from || 'Someone Special';

            document.getElementById('inputTo').value = data.to || '';
            document.getElementById('cardTo').textContent = toVal;
            document.getElementById('envTo').textContent = toVal;
            state.to = data.to || '';

            document.getElementById('inputTitle').value = data.title || '';
            document.getElementById('cardTitle').textContent = titleVal;
            state.title = data.title || '';

            document.getElementById('inputMsg').value = data.msg || '';
            document.getElementById('cardMsg').innerHTML = msgVal.replace(/\n/g, '<br>');
            state.msg = data.msg || '';

            document.getElementById('inputSign').value = data.sign || '';
            document.getElementById('cardSign').textContent = signVal;
            state.sign = data.sign || '';

            document.getElementById('inputFrom').value = data.from || '';
            document.getElementById('cardFrom').textContent = fromVal;
            state.from = data.from || '';

            if (data.color1 && data.color2) {
                state.color1 = data.color1; state.color2 = data.color2;
                applyColors(data.color1, data.color2);
            }

            if (data.emoji) { state.emoji = data.emoji; document.getElementById('cardEmoji').textContent = data.emoji; }
            if (data.sealEmoji) { state.sealEmoji = data.sealEmoji; document.getElementById('envSeal').textContent = data.sealEmoji; }
            if (data.font) { state.font = data.font; document.getElementById('cardTitle').className = 'card-title ' + data.font; }
            if (data.titleSize) { state.titleSize = data.titleSize; document.getElementById('cardTitle').style.fontSize = data.titleSize + 'rem'; }
            if (data.msgSize) { state.msgSize = data.msgSize; document.getElementById('cardMsg').style.fontSize = data.msgSize + 'rem'; }

            if (data.stickers && data.stickers.length) {
                data.stickers.forEach(s => {
                    const layer = document.getElementById(s.side === 'back' ? 'stickersBack' : 'stickersFront');
                    const el = document.createElement('div');
                    el.className = 'placed-sticker';
                    el.textContent = s.emoji;
                    el.style.fontSize = (s.size || 1.5) + 'rem';
                    el.style.left = s.x + '%';
                    el.style.top = s.y + '%';
                    layer.appendChild(el);
                });
                state.stickers = data.stickers;
            }

            cardId = data.id;
        }

        function toast(msg) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>
